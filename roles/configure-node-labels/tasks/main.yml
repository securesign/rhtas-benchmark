---
- name: "Get all worker nodes"
  kubernetes.core.k8s_info:
    kind: Node
    label_selectors:
      - node-role.kubernetes.io/worker=
  register: worker_nodes

- name: "Check if at least 2 worker nodes are available"
  ansible.builtin.fail:
    msg: "ERROR: At least 2 worker nodes are required for performance zone labeling, but found {{ worker_nodes.resources | length }}."
  when: worker_nodes.resources | length < 2

- name: "Set facts for the first two worker nodes"
  ansible.builtin.set_fact:
    database_node_name: "{{ worker_nodes.resources[0].metadata.name }}"
    application_node_name: "{{ worker_nodes.resources[1].metadata.name }}"

- name: "Check if the first node is already labeled for 'database'"
  kubernetes.core.k8s_info:
    kind: Node
    name: "{{ database_node_name }}"
  register: db_node_check
- name: "Set fact if database node needs labeling"
  ansible.builtin.set_fact:
    label_db_node: "{{ 'performance-zone' not in db_node_check.resources[0].metadata.labels or db_node_check.resources[0].metadata.labels['performance-zone'] != 'database' }}"

- name: "Check if the second node is already labeled for 'application'"
  kubernetes.core.k8s_info:
    kind: Node
    name: "{{ application_node_name }}"
  register: app_node_check
- name: "Set fact if application node needs labeling"
  ansible.builtin.set_fact:
    label_app_node: "{{ 'performance-zone' not in app_node_check.resources[0].metadata.labels or app_node_check.resources[0].metadata.labels['performance-zone'] != 'application' }}"

- name: "Apply 'database' label to the first worker node if needed"
  kubernetes.core.k8s:
    state: patched
    definition:
      apiVersion: v1
      kind: Node
      metadata:
        name: "{{ database_node_name }}"
        labels:
          performance-zone: database
  when: label_db_node

- name: "Apply 'application' label to the second worker node if needed"
  kubernetes.core.k8s:
    state: patched
    definition:
      apiVersion: v1
      kind: Node
      metadata:
        name: "{{ application_node_name }}"
        labels:
          performance-zone: application
  when: label_app_node

- name: "Refresh node information after applying labels"
  kubernetes.core.k8s_info:
    kind: Node
    label_selectors:
      - node-role.kubernetes.io/worker=
  register: updated_worker_nodes

- name: "Display final node labels for verification"
  ansible.builtin.debug:
    msg: "Node '{{ item.metadata.name }}' -> performance-zone: {{ item.metadata.labels['performance-zone'] | default('not set') }}"
  loop: "{{ updated_worker_nodes.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"